---
import { getCollection, render } from "astro:content";
import ContentLayout from "../../layouts/ContentLayout.astro";

export async function getStaticPaths() {
  const blogArray = await getCollection("blogs");
  return blogArray.map((blog) => {
    return {
      params: { blog: blog.id.split("/").at(-1) },
      props: { blog },
    };
  });
}

const { blog } = Astro.props;

const CHAR_PER_MIN = 238;

const title =
  blog.data.title ||
  blog.filePath?.split("/").at(-1)?.slice(0, -3) ||
  blog.id.split("/").at(-1) ||
  "untitled";

// Generate auto summary
const body = blog.body || "";
const paragraphs = body.split("\n");
const skip = /^[!#>]/; // Avoid callouts, headings, images
let autoSummary = blog.data.summary || ""; // Use frontmatter description if available

if (!autoSummary) {
  for (let i = 0; i < paragraphs.length; i++) {
    const paragraph = paragraphs[i].trim();
    if (paragraph.match(skip) || paragraph === "") continue;

    autoSummary = paragraph;
    // Strip markdown
    autoSummary = autoSummary.replace(/[*_]/g, "");
    autoSummary = autoSummary.replace(/\[(.*?)\]\(.*?\)/g, "$1"); // Replace links with link text

    if (autoSummary.length > CHAR_PER_MIN)
      autoSummary = `${autoSummary.slice(0, CHAR_PER_MIN)}...`;
    break; // Use the first valid paragraph
  }
}

const { Content } = await render(blog);
---

<ContentLayout title={title} summary={autoSummary}>
  <div slot="header" class="flex flex-col gap-y-2 items-center">
    <h1
      id={blog.data.title}
      class="text-4xl sm:text-5xl font-bold text-center"
      transition:name={blog.data.title}
    >
      {title}
    </h1>
    <div
      class="items-center w-full justify-evenly flex gap-x-5 text-sm text-zinc-400"
    >
      <p class="text-balance">
        Published: {blog.data.published?.toUTCString().slice(0, -13)}
      </p>
      {
        blog.data.edited && (
          <p class="text-balance">
            Edited: {blog.data.edited?.toUTCString().slice(0, -13)}
          </p>
        )
      }
      {
        blog.body && (
          <p class="whitespace-nowrap">
            ~{Math.floor(blog.body.split(" ").length / 238)} min read
          </p>
        )
      }
    </div>
  </div>

  <Content />
</ContentLayout>
